#!/bin/bash

# StoreKit Configuration Sync Check Script
# Checks the sync status of StoreKit Configuration

echo "üîç Checking StoreKit Configuration sync status..."

# Check for configuration file
CONFIG_FILE="Flippin/Configuration/StoreKitConfiguration.storekit"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå StoreKit Configuration file not found: $CONFIG_FILE"
    exit 1
fi

echo "‚úÖ StoreKit Configuration file found"

# Check sync settings
if grep -q '"_syncEnabled" : true' "$CONFIG_FILE"; then
    echo "‚úÖ Sync is enabled"
else
    echo "‚ö†Ô∏è  Sync is not enabled"
fi

if grep -q '"_syncMode" : "automatic"' "$CONFIG_FILE"; then
    echo "‚úÖ Automatic sync mode is enabled"
else
    echo "‚ö†Ô∏è  Automatic sync mode is not enabled"
fi

# Check for products
PRODUCT_COUNT=$(grep -c '"productID"' "$CONFIG_FILE")
echo "üì¶ Found $PRODUCT_COUNT products in configuration"

# Check specific products
REQUIRED_PRODUCTS=(
    "com.dor.flippin.unlimited_cards"
    "com.dor.flippin.premium_monthly"
    "com.dor.flippin.premium_yearly"
)

echo "üîç Checking required products:"
for product in "${REQUIRED_PRODUCTS[@]}"; do
    if grep -q "$product" "$CONFIG_FILE"; then
        echo "‚úÖ $product - found"
    else
        echo "‚ùå $product - missing"
    fi
done

# Check prices
echo "üí∞ Checking prices:"
if grep -q '"displayPrice"' "$CONFIG_FILE"; then
    echo "‚úÖ Prices are configured"
else
    echo "‚ö†Ô∏è  Prices are not configured"
fi

# Check subscriptions
echo "üìÖ Checking subscriptions:"
if grep -q '"subscriptionGroups"' "$CONFIG_FILE"; then
    echo "‚úÖ Subscription groups are configured"
else
    echo "‚ö†Ô∏è  Subscription groups are not configured"
fi

echo ""
echo "üìã Summary:"
echo "- Configuration file: ‚úÖ"
echo "- Products found: $PRODUCT_COUNT"
echo "- Sync enabled: $(grep -q '_syncEnabled.*true' "$CONFIG_FILE" && echo "‚úÖ" || echo "‚ùå")"
echo "- Automatic sync: $(grep -q '_syncMode.*automatic' "$CONFIG_FILE" && echo "‚úÖ" || echo "‚ùå")"

echo ""
echo "üí° Next steps:"
echo "1. Open Xcode"
echo "2. Go to Product ‚Üí StoreKit ‚Üí Manage StoreKit Configuration"
echo "3. Click 'Sync with App Store Connect'"
echo "4. Sign in with your Apple Developer account"
echo "5. Select your app and sync"

echo ""
echo "üîß For manual sync in Xcode:"
echo "Product ‚Üí StoreKit ‚Üí Manage StoreKit Configuration ‚Üí Sync Now" 